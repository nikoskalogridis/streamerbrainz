# StreamerBrainz Rotary Encoder Configuration Example
#
# This example demonstrates how to configure StreamerBrainz with rotary encoders
# for volume control, including velocity detection for "fast spinning" behavior.
#
# Recommended location:
#   ~/.config/streamerbrainz/config.yaml

# ============================================================================
# Input Devices Configuration
# ============================================================================
ir:
  # New input_devices format with explicit device types
  # Each device must specify its type: "key" or "rotary"
  input_devices:
    # IR Remote (EV_KEY events - uses velocity/hold system)
    - path: /dev/input/by-id/usb-FLIRC.tv_flirc-event-kbd
      type: key

    # Rotary Encoder (EV_REL events - step-based control)
    - path: /dev/input/by-id/usb-Griffin_PowerMate-event-if00
      type: rotary

    # USB Volume Knob (EV_REL events)
    - path: /dev/input/by-id/usb-Contour_Design_ShuttleXpress-event-if00
      type: rotary

  # Legacy format (deprecated but still supported):
  # All devices default to "key" type
  # devices:
  #   - /dev/input/event6

# ============================================================================
# Rotary Encoder Configuration
# ============================================================================
rotary:
  # Volume change per encoder step/detent (dB)
  # Smaller values = finer control, larger values = faster response
  # Typical range: 0.25 to 1.0 dB
  db_per_step: 0.5

  # Velocity detection window (milliseconds)
  # Steps within this window are counted to detect "fast spinning"
  # Smaller = more sensitive to fast spins, larger = smoother
  # Typical range: 100-300 ms
  velocity_window_ms: 200

  # Velocity multiplier for "fast spinning"
  # When threshold is exceeded, multiply step size by this factor
  # 1.0 = disabled, 2.0 = double speed, 3.0 = triple speed
  # Typical range: 1.5 to 3.0
  velocity_multiplier: 2.0

  # Velocity threshold (steps in window)
  # Number of steps in velocity_window_ms to trigger velocity mode
  # Lower = easier to trigger, higher = requires faster spinning
  # Typical range: 2-5 steps
  velocity_threshold: 3

# ============================================================================
# How Rotary Encoders Work
# ============================================================================
#
# Rotary encoders send events differently than keyboards/remotes:
#
# 1. EV_REL Events (most common):
#    - Device sends REL_DIAL, REL_WHEEL, or REL_MISC codes
#    - Value = +1 for clockwise, -1 for counter-clockwise (per detent)
#    - Some encoders send larger values for multiple detents
#    - These bypass the velocity/hold system entirely
#
# 2. EV_KEY Events (less common):
#    - Device sends KEY_VOLUMEUP/DOWN press+release per detent
#    - These devices should use type: "key" to get hold/repeat behavior
#    - Less ideal for encoders but works for basic knobs
#
# Velocity Detection:
#   Slow turn:  1 step every 500ms  → normal speed (0.5 dB/step)
#   Fast spin:  5 steps in 200ms    → velocity mode (1.0 dB/step)
#
# This gives fine control for small adjustments, fast changes for big sweeps.
#
# ============================================================================

# ============================================================================
# Identifying Your Encoder Type
# ============================================================================
#
# Use evtest to see what events your encoder sends:
#
#   sudo evtest /dev/input/event6
#
# Then turn the knob and look for:
#
# EV_REL encoder (set type: rotary):
#   Event: time 1234.567890, type 2 (EV_REL), code 7 (REL_DIAL), value 1
#   Event: time 1234.567890, type 2 (EV_REL), code 8 (REL_WHEEL), value -1
#
# EV_KEY encoder (set type: key):
#   Event: time 1234.567890, type 1 (EV_KEY), code 115 (KEY_VOLUMEUP), value 1
#   Event: time 1234.567900, type 1 (EV_KEY), code 115 (KEY_VOLUMEUP), value 0
#
# ============================================================================

# ============================================================================
# CamillaDSP Configuration
# ============================================================================
camilladsp:
  ws_url: ws://127.0.0.1:1234
  timeout_ms: 500
  min_db: -65.0
  max_db: 0.0
  update_hz: 30

# ============================================================================
# Velocity Engine Configuration (for KEY-type devices only)
# ============================================================================
velocity:
  # Rotary encoders (type: rotary) bypass this system entirely
  # This only applies to keyboards, remotes, and key-type encoders

  mode: accelerating
  max_db_per_sec: 15.0
  accel_time_sec: 2.0
  decay_tau_sec: 0.2
  hold_timeout_ms: 600

  # Danger zone protection applies to both rotary and key devices
  danger_zone_db: 12.0
  danger_vel_max_db_per_sec: 3.0
  danger_vel_min_near0_db_per_sec: 0.3

# ============================================================================
# IPC, Webhooks, Plex
# ============================================================================
ipc:
  socket_path: /tmp/streamerbrainz.sock

webhooks:
  port: 3001

plex:
  enabled: false

# ============================================================================
# Logging
# ============================================================================
logging:
  # Use 'debug' to see rotary encoder events and velocity detection
  level: info

# ============================================================================
# Common Rotary Encoder Devices
# ============================================================================
#
# Griffin PowerMate:
#   - EV_REL (REL_DIAL)
#   - Includes push button (KEY_ENTER or configurable)
#   - Good tactile feedback
#
# Contour Design ShuttleXpress:
#   - EV_REL (REL_DIAL for jog wheel)
#   - Shuttle ring sends different codes
#   - Professional editing controller
#
# Custom Arduino/Raspberry Pi encoders:
#   - Usually EV_REL (REL_DIAL or REL_MISC)
#   - Configure in device firmware or kernel driver
#   - Infinite rotation, various detent counts
#
# USB "Volume Knob" devices:
#   - Some send EV_KEY (volumeup/down per detent) → use type: key
#   - Some send EV_REL (dial events) → use type: rotary
#   - Check with evtest before configuring
#
# ============================================================================

# ============================================================================
# Tuning Guide
# ============================================================================
#
# For fine volume control (mixing, critical listening):
#   db_per_step: 0.25
#   velocity_multiplier: 1.5
#   velocity_threshold: 4
#
# For balanced control (general use):
#   db_per_step: 0.5
#   velocity_multiplier: 2.0
#   velocity_threshold: 3
#
# For coarse control (quick adjustments):
#   db_per_step: 1.0
#   velocity_multiplier: 2.5
#   velocity_threshold: 2
#
# To disable velocity detection:
#   velocity_multiplier: 1.0
#   (threshold and window become irrelevant)
#
# ============================================================================

# ============================================================================
# Mixed Input Setup Example
# ============================================================================
#
# Common scenario: IR remote for couch control + desk rotary knob
#
# ir:
#   input_devices:
#     # Remote for basic control from couch
#     - path: /dev/input/by-id/usb-FLIRC.tv_flirc-event-kbd
#       type: key
#
#     # Precision knob at desk
#     - path: /dev/input/by-id/usb-Griffin_PowerMate-event-if00
#       type: rotary
#
# rotary:
#   db_per_step: 0.5              # Fine control
#   velocity_multiplier: 2.0       # 2x speed when spinning fast
#
# velocity:
#   mode: constant                 # Remote uses constant rate
#   max_db_per_sec: 10.0          # Slower than default
#   turbo_mult: 2.0               # Turbo after 0.5s hold
#   turbo_delay_sec: 0.5
#
# This gives precise rotary control + comfortable remote hold behavior.
#
# ============================================================================

# ============================================================================
# Troubleshooting Rotary Encoders
# ============================================================================
#
# Encoder does nothing:
#   - Check device type is set to "rotary" for EV_REL encoders
#   - Verify device sends REL_DIAL/REL_WHEEL/REL_MISC with evtest
#   - Check logging.level: debug to see if events are received
#   - Ensure user has read permission on /dev/input/eventX
#
# Encoder jumps too much:
#   - Reduce db_per_step (try 0.25 or 0.3)
#   - Reduce velocity_multiplier or disable (set to 1.0)
#   - Increase velocity_threshold
#
# Encoder too slow:
#   - Increase db_per_step (try 0.75 or 1.0)
#   - Increase velocity_multiplier (try 2.5 or 3.0)
#   - Decrease velocity_threshold (try 2)
#
# Velocity mode not triggering:
#   - Increase velocity_window_ms (try 300 or 400)
#   - Decrease velocity_threshold (try 2)
#   - Check debug logs to see step counts
#
# Encoder feels "lumpy" or inconsistent:
#   - Some encoders send bursts of events per detent
#   - Try increasing velocity_window_ms to smooth it out
#   - Experiment with db_per_step to find sweet spot
#
# Wrong direction:
#   - This is device-specific (hardware wiring)
#   - No software fix currently - rewire encoder or adjust in firmware
#   - Or swap usage (turn right when you want volume down)
#
# ============================================================================
